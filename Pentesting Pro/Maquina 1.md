# Gu√≠a de Pentesting - M√°quina 1

**Curso:** Pentesting Pro.   
**Objetivo:** Comprometer la m√°quina y obtener acceso root/administrador.
## üì∂ Reconocimiento
1. Descubrimiento de Host con `arp-scan`  

![](images/Descubrimiento%20de%20Hosts.png)  
- IP de maquina objetivo **192.168.100.136**  

Tambi√©n podemos realizar un descubrimiento del host haciendo uso del comando `nmap -sn ip`

## üîç Escaneo de puertos con Nmap
Realizamos un escaneo completo de puertos.  
![Escaneo de puertos](images/Escaneo%20de%20puertos.png)  
Hallazgos;
- Puerto `80/tcp` **HTTP** Servicio **nginx 1.18.0**

## üåê Acceso al servidor web
Accedemos mediante el navegador a la direcci√≥n `192.168.100.136` y encontramos una p√°gina con un bot√≥n de login.  
![P√°gina web](images/P√°gina%20web.png)  
- El bot√≥n de login redirige a `http://doc.hmv/admin`.
- Sin la resoluci√≥n `DNS` adecuada, el navegador no podr√° resolver `doc.hmv`.
- Al agregar la entrada al archivo `hosts`, forzamos la resoluci√≥n localmente.

Para Agregarlo usamos el comando: `sudo nano /etc/hosts`.  

**Una vez agregada la entrada al archivo hosts:**
- ‚úÖ Ya no es necesario usar la direcci√≥n IP en el navegador.
- ‚úÖ Podemos acceder directamente mediante: `http://doc.hmv`.
- ‚úÖ Todos los enlaces y redirecciones funcionar√°n correctamente.
- ‚úÖ Las herramientas de l√≠nea de comandos tambi√©n pueden usar el nombre de dominio.  

![P√°gina del bot√≥n de login](images/Bot√≥n%20de%20login.png)  

## ‚öîÔ∏èExplotaci√≥n
Detecci√≥n de vulnerabilidades `SQL Injection`
**Herramientas utilizadas:**
- `Burp Suite`
- Extensi√≥n de navegador (`FoxyProxy`)
**Procedimiento:**
1. Configuraci√≥n de `Burp Suite:`
	- Iniciamos `Burp Suite` y configuramos el proxy en el puerto 8080.
	- Configuramos el navegador para usar el proxy local (127.0.0.1:8080).
2. Interceptaci√≥n de trafico:
	- Activamos la interceptaci√≥n en `Burp Suite`.
	- Intentamos iniciar sesi√≥n en el formulario de login en `http://doc.hmv/admin`.
	- `Burp Suite` captura la solicitud `POST`.
3. **Detecci√≥n de vulnerabilidad:**
	- Enviamos la solicitud capturada a `Repeater` (**CTRL + R**).
	- Probamos `payloads` b√°sicos de `SQL Injection` en los par√°metros: `' OR 1=1 #`  

![SQL Injection - Burp Suite](images/SQL%20Injection%20-%20Burp%20Suite.png)  
**Resultado:**  
Acceso exitoso al panel de administraci√≥n.  

![Panel de administraci√≥n](images/Panel%20de%20administraci√≥n.png)  
**Ubicaci√≥n en el panel:**  
Despu√©s de acceder al panel de administraci√≥n mediante SQL Injection, exploramos la secci√≥n "User List" donde encontramos 2 usuarios:  

![Lista de usuarios](images/User%20List.png)  

## üß† Fuerza bruta con Burp Suite
**Procedimiento ejecutado:**
1. **Captura de la solicitud de autenticaci√≥n:**
    - Interceptamos la solicitud de login con `Burp Suite`.
    - La solicitud la enviamos al m√≥dulo `Intruder`.
2. **Configuraci√≥n de posiciones en `Intruder`:**
    - Marcamos el campo `password=admin` con la opci√≥n `Add ¬ß`.
    - El ataque se configur√≥ como **Cluster Bomb** para probar m√∫ltiples combinaciones.
3. **Configuraci√≥n de payload:**
    - **Payload:** Diccionario personalizado creado con: `head -n 100 /usr/share/wordlists/rockyou.txt > diccionario.txt`.  

![Burp Suite - Intruder](images/Intruder.png)  
**Procedimiento de identificaci√≥n de credenciales v√°lidas:**
1. **Ejecuci√≥n del ataque:**
    - Iniciamos el ataque con el diccionario de 100 contrase√±as.
    - Observamos la pesta√±a **Length** para identificar respuestas an√≥malas.
2. **Identificaci√≥n de la contrase√±a correcta:**
    - Buscamos un valor de longitud (**Length**) diferente a los dem√°s.
    - Al encontrar un **length** √∫nico, seleccionamos esa **request**.
    - Verificamos en la pesta√±a **Response** el contenido.
3. **Confirmaci√≥n de √©xito:**
    - La respuesta contiene: `{"status":"success"}`.
    - Esto indica autenticaci√≥n exitosa.  

![Ataque Intruder](images/Ataque%20Intruder.png)   
**Credenciales comprometidas:**
- Usuario: **vagrant**
- Contrase√±a: **chelsea**  

![Panel de administaci√≥n vagrant](images/Panel%20user%20administrator.png)  

## Explotaci√≥n mediante subida de Reverse Shell PHP
**Procedimiento:**
1. **Generaci√≥n del c√≥digo de `reverse shel`l:**
    - Accedemos a [revshells.com](https://www.revshells.com/).
    - Seleccionamos la opci√≥n "PHP PentestingMonkey".
    - Configuramos con nuestra IP.
    - Copiamos el c√≥digo generado.
2. Creaci√≥n del archivo `PHP`
	`nano reverse.php`
3. Configuraci√≥n del Listener  

    ‚ö†Ô∏è **Paso critico - Antes de subir el archivo**  
    Iniciamos `netcat` en modo escucha en el puerto 9001
    `nc -lnvp 9001`

**Explicaci√≥n:**
- `-l`: Modo escucha (listener).
- `-n`: No resolver nombres DNS.
- `-v`: Modo verbose (muestra conexiones entrantes).
- `-p`: Especifica el puerto (9001).
4. Subida del archivo malicioso
**Ubicaci√≥n en el panel:**
- Secci√≥n **Mi cuenta** ‚Üí **Cambiar avatar**.

**Procedimiento de subida:**
1. Seleccionamos el archivo `reverse.php` como nueva imagen de perfil.
2. Confirmamos la subida.
3. Observamos la respuesta del sistema.

‚ö†Ô∏è **Importante:** Mantener el terminal con `netcat` en escucha durante todo el proceso.

**Resultado esperado:**  
- La reverse shell se ejecutar√° autom√°ticamente.
- `Netcat` recibir√° la conexi√≥n entrante.
- Obtendremos acceso al sistema.  

![Netcar](images/Netcat.png)  

## üëë Escalada de privilegios a root
### Obtenci√≥n de Credenciales y Acceso al Usuario "bella"
Durante la enumeraci√≥n del sistema, se encontraron credenciales en el archivo **/var/www/html/traffic_offence/initialize.php**:  
![Ruta del directorio](images/Ruta%20del%20directorio.png)  
**Credenciales:**  
![Usuario bella](images/Credenciales.png)  
DB_USERNAME = **bella**  
DB_PASSWORD = **be114yTU**  

**Verificaci√≥n de la existencia del usuario "bella":**  
**cat /etc/passwd | grep "bella"**  
![Usuario bella](images/Usuario%20Existente.png)  
**Acceso al usuario `bella` mediante su contrase√±a:**  
![Usuario bella](images/Usuario%20bella.png)  
- su bella
- Password: be114yTU
### Exploraci√≥n del Directorio Home y Captura de la Flag
**Navegaci√≥n al directorio home de `bella`:**  
![Flag1](images/Flag1.png)  
**Contenido de user.txt:**  
Flag: **HMVtakemydocs**
### Enumeraci√≥n de Privilegios de Sudo
**Ejecuci√≥n de `sudo -l` para verificar privilegios:**
![Privilegios de sudo](images/Privilegios.png)  
Esto indica que el usuario `bella` puede ejecutar `/usr/bin/less` como **root** sin necesidad de contrase√±a.
### Explotaci√≥n de less para Escalada de Privilegios
**Referencia a GTFOBins:**  
Para explotar correctamente la vulnerabilidad de `less` con permisos sudo, nos apoyamos en [GTFOBins](https://gtfobins.github.io/), un recurso esencial que documenta m√©todos de explotaci√≥n de binarios leg√≠timos para bypass de restricciones de seguridad.  
**M√©todo de explotaci√≥n seg√∫n GTFOBins:** `sudo less /etc/profile`  
- Una vez dentro de `less`, presionamos **!** para entrar en el modo de comandos.
- Escribir `bash` o `sh` y presionamos **Enter**: `!/bin/bash`.
- Esto ejecutar√° una shell interactiva como `root`.  

![Acceso Root](images/Root.png)  
### Exploraci√≥n del Directorio Root y Captura de la Flag
**Navegaci√≥n al directorio root de root:**  
![Flag2](images/Flag2.png)  
**Contenido de root.txt:**
Flag: **HMVfinallyroot**  

## ‚úÖ Conclusi√≥n
- **Acceso inicial**: Explotaci√≥n de `SQL Injection` en formulario de login + subida de `reverse shell PHP` mediante funci√≥n de cambio de avatar.
- **Escalada de privilegios**:
    - Usuario web ‚Üí `vagrant` (fuerza bruta con `Burp Suite` - contrase√±a d√©bil).   
    - `vagrant` ‚Üí `bella` (credenciales DB en `/var/www/html/traffic_offence/initialize.php`: `bella:be114yTU`).   
    - `bella` ‚Üí `root` (abuso de `sudo /usr/bin/less` mediante t√©cnica de **GTFOBins**).    
- üéØ **Objetivo obtenido**: Shell de `root` obtenida con acceso completo al sistema.